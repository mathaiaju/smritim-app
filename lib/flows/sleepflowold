import 'dart:developer';
import 'package:smritim_app/flows/mood_flow.dart';

import '../chatbot/chatbot_state.dart';

class SleepResult {
  final String titleKey;
  final String tipKey;

  SleepResult(this.titleKey, this.tipKey);
}

class SleepFlow {
  static void start(dynamic screen) {
    log('ğŸ›Œ SleepFlow.start()');

    screen.sleep.clear();

    // ğŸ”‘ ENTER SLEEP FLOW
    screen.activeFlow = ActiveFlow.sleep;
    screen.phase = ChatPhase.sleepStart;

    screen.addBotMessage(
      'How would you rate your sleep quality?',
      quickReplies: [
        'ğŸ˜´ Very poor',
        'ğŸ˜• Poor',
        'ğŸ˜ Fair',
        'ğŸ™‚ Good',
        'ğŸ˜ƒ Very good',
      ],
    );

    screen.setState(() {});
  }

  static void handleSleepStart(dynamic screen, String text) {
    screen.addUserMessage(text);

    screen.sleep['quality'] = mapSleepQuality(text);
    screen.sleepQualityScore = screen.sleep['quality'];

    screen.phase = ChatPhase.sleepQ1;

    screen.addBotMessage(
      'How long did it take you to fall asleep?',
      quickReplies: onsetOptions(screen),
    );
    screen.setState(() {});
  }

  static void handleSleepQ1(dynamic screen, String text) {
    screen.addUserMessage(text);

    screen.sleep['onset'] = mapSleepOnset(text);
    screen.phase = ChatPhase.sleepQ2;

    screen.addBotMessage(
      'How often did you wake up during the night?',
      quickReplies: maintenanceOptions(screen),
    );
    screen.setState(() {});
  }

  static void handleSleepQ2(dynamic screen, String text) {
    screen.addUserMessage(text);

    screen.sleep['maintenance'] = mapSleepMaintenance(text);
    screen.phase = ChatPhase.sleepQ3;

    screen.addBotMessage(
      'How many hours did you sleep?',
      quickReplies: durationOptions(screen),
    );
    screen.setState(() {});
  }

  static void handleSleepQ3(dynamic screen, String text) {
    screen.addUserMessage(text);

    screen.sleep['duration'] = mapSleepDuration(text);
    screen.phase = ChatPhase.sleepQ4;

    screen.addBotMessage(
      'How refreshed did you feel on waking?',
      quickReplies: restfulnessOptions(screen),
    );
    screen.setState(() {});
  }

  static void handleSleepQ4(dynamic screen, String text) {
    screen.addUserMessage(text);

    screen.sleep['restfulness'] = mapSleepRestfulness(text);
    screen.phase = ChatPhase.sleepQ5;

    screen.addBotMessage(
      'Did poor sleep affect your daytime functioning?',
      quickReplies: daytimeImpactOptions(screen),
    );
    screen.setState(() {});
  }

  static Future<void> handleSleepQ5(dynamic screen, String text) async {
    print("ğŸ”¥ ENTERED handleSleepQ5");
    screen.addUserMessage(text);

    screen.sleep['daytime_impact'] = mapDaytimeImpact(text);

    final result = calculateScore(screen.sleep);

    screen.addBotMessage('Sleep Quality: ${result.titleKey}');
    screen.addBotMessage('Tip: ${result.tipKey}');

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Critical â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    screen.sleepCapturedToday = true;
    screen.activeFlow = ActiveFlow.none;
    screen.setState(() {});

// ğŸ”¥ DIRECT orchestration (no routing)
    screen.replyHandler.submitSleep();

    if (!screen.moodCapturedToday) {
      MoodFlow.start(screen);
    }
  }

  static SleepResult calculateScore(Map<String, int> sleepAnswers) {
    final totalScore = sleepAnswers.values.fold(0, (sum, score) => sum + score);

    if (totalScore >= 17) {
      return SleepResult(
        'Excellent sleep â­â­â­â­â­',
        'Great job maintaining healthy sleep habits.',
      );
    } else if (totalScore >= 13) {
      return SleepResult(
        'Good sleep â­â­â­â­â˜†',
        'You slept fairly well. Maintain consistency.',
      );
    } else if (totalScore >= 9) {
      return SleepResult(
        'Poor sleep â­â­â˜†â˜†â˜†',
        'Try improving bedtime routines and reducing screen exposure.',
      );
    } else {
      return SleepResult(
        'Very poor sleep â­â˜†â˜†â˜†â˜†',
        'Consider discussing sleep concerns with your clinician.',
      );
    }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€ OPTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€

  static List<String> onsetOptions(dynamic screen) =>
      ['<15 min', '15â€“30 min', '30â€“60 min', '60 min'];

  static List<String> maintenanceOptions(dynamic screen) =>
      ['Not at all', '1â€“2 times', '3â€“4 times', 'â‰¥5 times'];

  static List<String> durationOptions(dynamic screen) =>
      ['â‰¥7 hours', '6â€“7 hours', '5â€“6 hours', '<5 hours'];

  static List<String> restfulnessOptions(dynamic screen) =>
      ['Very refreshed', 'Somewhat refreshed', 'Slightly tired', 'Very tired'];

  static List<String> daytimeImpactOptions(dynamic screen) =>
      ['Not at all', 'Mildly', 'Moderately', 'Severely'];

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€ MAPPING â”€â”€â”€â”€â”€â”€â”€â”€â”€

  static int mapSleepQuality(String text) {
    if (text.contains('Very poor') || text.contains('ğŸ˜´')) return 1;
    if (text.contains('Poor') || text.contains('ğŸ˜•')) return 2;
    if (text.contains('Fair') || text.contains('ğŸ˜')) return 3;
    if (text.contains('Good') || text.contains('ğŸ™‚')) return 4;
    if (text.contains('Very good') || text.contains('ğŸ˜ƒ')) return 5;
    return 1 + (text.hashCode.abs() % 5);
  }

  static int mapSleepOnset(String text) {
    if (text.contains('<15 min')) return 4;
    if (text.contains('15â€“30 min')) return 3;
    if (text.contains('30â€“60 min')) return 2;
    if (text.contains('60 min')) return 1;
    return 1 + (text.hashCode.abs() % 4);
  }

  static int mapSleepMaintenance(String text) {
    if (text.contains('Not at all')) return 4;
    if (text.contains('1â€“2 times')) return 3;
    if (text.contains('3â€“4 times')) return 2;
    if (text.contains('â‰¥5 times')) return 1;
    return 1 + (text.hashCode.abs() % 4);
  }

  static int mapSleepDuration(String text) {
    if (text.contains('â‰¥7 hours')) return 4;
    if (text.contains('6â€“7 hours')) return 3;
    if (text.contains('5â€“6 hours')) return 2;
    if (text.contains('<5 hours')) return 1;
    return 1 + (text.hashCode.abs() % 4);
  }

  static int mapSleepRestfulness(String text) {
    if (text.contains('Very refreshed')) return 4;
    if (text.contains('Somewhat refreshed')) return 3;
    if (text.contains('Slightly tired')) return 2;
    if (text.contains('Very tired')) return 1;
    return 1 + (text.hashCode.abs() % 4);
  }

  static int mapDaytimeImpact(String text) {
    if (text.contains('Not at all')) return 4;
    if (text.contains('Mildly')) return 3;
    if (text.contains('Moderately')) return 2;
    if (text.contains('Severely')) return 1;
    return 1 + (text.hashCode.abs() % 4);
  }
}
